import{x as P}from"./goods-CB7YWqUH.js";import{w as Ie,x as Le,y as he}from"./promotion-ChRoyrm_.js";import{R as E}from"./validator-B8pIxTAL.js";import{I as M}from"./dist-PezRi_EG.js";import{d as Ge,r as _,p as Ce,n as Ue,af as x,a as Oe,h as Ve,E as Ae,b,o as r,c as C,e as i,w as a,u as o,k as m,Z as B,f as c,j as v,s as p,q as ue,t as q,F as de,i as ne,M as R,_ as Re}from"./index-C4AMdMz2.js";const we={class:"base-info-item"},Fe={class:"form-item-view"},Se={style:{"margin-top":"20px","margin-bottom":"20px"}},De={class:"form-item-view"},Ee={key:0,style:{display:"flex"}},Ye={style:{display:"flex","margin-bottom":"10px"}},Pe={key:2},Me={key:0,style:{display:"flex"}},xe={style:{display:"flex","margin-bottom":"10px"}},Be={key:3},qe={"ml-8px":""},$e={class:"errorMessage"},He=Ge({__name:"gift-detail",setup(je){const $=_(),N=_(""),w=_(""),F=Ce(),H=Ue(),U=_(!0),n=_(F.query.onlyView==="true"),j=_(null),W=_(null),J=_(null),S=_(0),O=_([]),f=_([]),s=_({promotionName:"",rangeTime:[x().format("YYYY-MM-DD HH:mm:ss"),x().add(1,"month").format("YYYY-MM-DD HH:mm:ss")],description:"",fullMoney:"",discountType:"RATE",fullMinus:"",fullRate:"",promotionStatus:"NEW",couponId:"",giftId:"",points:0,scopeType:"ALL",promotionGoodsList:[],fullThreshold:0,giftActivityType:"",rulesItems:[{countThreshold:"",consumeThreshold:"",giftList:[]}]}),re=[{title:"商品名称",dataIndex:"goodsName"},{title:"商品价格",dataIndex:"price",currency:!0},{title:"操作",slotName:"Optiona"}],me=[{title:"赠品名称",dataIndex:"goodsName"},{title:"赠送数量",dataIndex:"giftNum",slotName:"giftNum"},{title:"赠品总套数",dataIndex:"packageNum",slotName:"packageNum"},{title:"赠品库存",dataIndex:"stockNum"},{title:"操作",slotName:"Optiona"}],K=Oe({onlyCurrent:!0}),V=_([]);async function pe(){const l=await Ie(F.query.id);if(l.data.success){const e=l.data.result;e.scopeType==="ALL"&&(e.promotionGoodsList=[]),e.rangeTime=[],e.rangeTime.push(e.startTime,e.endTime),s.value=e,(e.giftActivityType==="FULL_COUNT"||e.giftActivityType==="FULL_PRICE")&&(s.value.rulesItems=e.giftGoodsJson),N.value="",O.value=e.promotionGoodsList,f.value=e.giftGoodsList}}async function ce(){if(s.value.rulesItems.length>=3)return R.error("最多设置3个促销规则"),!1;s.value.rulesItems.push({countThreshold:"",consumeThreshold:"",giftList:[]})}async function z(l){if(s.value.rulesItems.length<=1)return R.error("最少设置1个促销规则"),!1;s.value.rulesItems.splice(l,1)}function Q(){H.push({name:"gift"})}async function fe(){var e;if(!await((e=$.value)==null?void 0:e.validate())){if(s.value.giftActivityType!=="BUY_GIFT"&&!U.value)return;const t=JSON.parse(JSON.stringify(s.value));if(t.giftGoodsList=f.value,t.promotionGoodsList=O.value,t.startTime=s.value.rangeTime[0],t.endTime=s.value.rangeTime[1],t.scopeType==="PORTION_GOODS"&&(!t.promotionGoodsList||t.promotionGoodsList.length===0)){R.warning("请选择指定商品");return}if(t.scopeType==="ALL")delete t.promotionGoodsList,t.number=-1;else{const d=[];t.number=1,t.promotionGoodsList.forEach(g=>{g.startTime=t.startTime,g.endTime=t.endTime,d.push(g.skuId)}),t.scopeId=d.toString()}if(t.giftActivityType==="BUY_COUNT"&&(!(t!=null&&t.giftGoodsList)||t.giftGoodsList.length===0)){R.warning("请选择赠送商品");return}if(delete t.rangeTime,t.giftActivityType==="FULL_PRICE"){const d=[];t.rulesItems.forEach(g=>{g.giftList.forEach(T=>{const A={consumeThreshold:g.consumeThreshold,goodsId:T.goodsId,skuId:T.skuId,goodsName:T.goodsName,stockNum:T.stockNum,thumbnail:T.thumbnail};d.push(A)})}),t.giftGoodsList=d}else if(t.giftActivityType==="FULL_COUNT"){const d=[];t.rulesItems.forEach(g=>{g.giftList.forEach(T=>{const A={countThreshold:g.countThreshold,goodsId:T.goodsId,skuId:T.skuId,goodsName:T.goodsName,stockNum:T.stockNum,thumbnail:T.thumbnail};d.push(A)})}),t.giftGoodsList=d}F.query.id?(delete t.updateTime,he(t).then(d=>{d.data.success&&(R.success("编辑活动成功"),Q())})):(delete t.id,Le(t).then(d=>{d&&d.data&&d.data.success&&(R.success("添加活动成功"),Q())}))}}function Z(l){w.value=l,l==="PROMOTION"?j.value.modalData.visible=!0:W.value.modalData.visible=!0}function Y(l){if(w.value==="PROMOTION"){const e=[];l.forEach(t=>{const d={settlementPrice:t.settlementPrice||0,pointsGoodsCategoryId:t.pointsGoodsCategoryId||0,pointsGoodsCategoryName:t.pointsGoodsCategoryName||"",activeStock:t.activeStock||0,points:t.points||0,skuId:t.id,goodsId:t.goodsId,originalPrice:t.price||0,thumbnail:t.thumbnail||"",goodsName:t.goodsName||"",quantity:t.quantity||"",storeName:t.storeName||"",price:t.price||""};e.push(d)}),O.value=e}else if(w.value==="GIFT"){const e=[];l.forEach(t=>{const d={skuId:t.id,goodsId:t.goodsId,thumbnail:t.thumbnail||"",goodsName:t.goodsName||"",quantity:t.quantity||"",storeName:t.storeName||"",giftNum:t.giftNum||0,packageNum:t.packageNum||0,stockNum:t.stockNum||0};e.push(d)}),f.value=e}else if(w.value==="LADDER_GIFT"){const e=[];l.forEach((t,d)=>{if(d<10){const g={skuId:t.id,goodsId:t.goodsId,thumbnail:t.thumbnail||"",goodsName:t.goodsName||"",quantity:t.quantity||"",storeName:t.storeName||"",giftNum:t.giftNum||0,packageNum:t.packageNum||0,stockNum:t.stockNum||0};e.push(g)}}),s.value.rulesItems[S.value].giftList=e}}function X(l,e){l==="PROMOTION"?O.value.splice(e,1):l==="GIFT"&&f.value.splice(e,1)}function ge(l){s.value.rulesItems[S.value].giftList.splice(l,1)}function ee(l,e){w.value=l,S.value=e,J.value.modalData.visible=!0}function ye(l){l==="BUY_GIFT"&&(s.value.scopeType="ALL",N.value=""),l==="FULL_PRICE"&&(s.value.scopeType="ALL",s.value.rulesItems=[{consumeThreshold:"",countThreshold:"",giftList:[]}],N.value=""),l==="FULL_COUNT"&&(s.value.scopeType="ALL",s.value.rulesItems=[{consumeThreshold:"",countThreshold:"",giftList:[]}],N.value="")}function ve(l,e){f.value[e].giftNum=l,f.value[e].packageNum&&f.value[e].giftNum&&(f.value[e].stockNum=f.value[e].packageNum*f.value[e].giftNum)}function ke(l,e){f.value[e].packageNum=l,f.value.forEach(t=>{t.packageNum=l,t.packageNum&&t.giftNum&&(t.stockNum=t.packageNum*t.giftNum)}),f.value[e].packageNum&&f.value[e].giftNum&&(f.value[e].stockNum=f.value[e].packageNum*f.value[e].giftNum)}return Ve(async()=>{F.query.id?pe():s.value.giftActivityType="BUY_GIFT",N.value="";const l=x().format("YYYYMMDD HH:mm:ss");s.value.promotionName=`赠品活动-${l}`}),Ae(()=>s.value.rulesItems,l=>{if(l)for(let e=0;e<l.length;e++){if(s.value.giftActivityType==="FULL_PRICE"){if(!l[e].consumeThreshold){N.value="【消费门槛】不可为空",U.value=!1;return}if(!l[e].giftList||l[e].giftList.length===0){N.value="请添加赠品",U.value=!1;return}else{const t=l[e].giftList.filter(d=>d.stockNum<=0);if(t.length){N.value="赠品需要填写赠品数量",t.value=!1;return}}if(e<l.length-1){const t=l[e],d=l[e+1];if(t.consumeThreshold&&t.consumeThreshold>=d.consumeThreshold){N.value="下一个层级的【消费门槛】需要大于上一个层级的【消费门槛】",U.value=!1;return}}}else if(s.value.giftActivityType==="FULL_COUNT"){if(!l[e].countThreshold){N.value="【消费门槛】不可为空",U.value=!1;return}if(e<l.length-1){const t=l[e],d=l[e+1];if(t.countThreshold&&t.countThreshold>=d.countThreshold){N.value="下一个层级的【消费门槛】需要大于上一个层级的【消费门槛】",U.value=!1;return}}}N.value="",U.value=!0}},{deep:!0,immediate:!0}),(l,e)=>{var se,le;const t=b("a-typography-text"),d=b("a-space"),g=b("a-radio"),T=b("a-radio-group"),A=b("a-input"),L=b("a-form-item"),Ne=b("a-range-picker"),I=b("a-button"),te=b("a-table"),D=b("a-input-number"),oe=b("a-input-group"),Te=b("a-image"),be=b("a-form"),_e=b("a-card");return r(),C("div",null,[i(_e,{bordered:!1},{default:a(()=>[i(be,{ref_key:"modifyPriceForm",ref:$,model:o(s),style:{width:"100%"},layout:"horizontal","auto-label-width":""},{default:a(()=>[m("div",we,[e[38]||(e[38]=m("h4",null,"活动信息",-1)),m("div",Fe,[m("div",Se,[i(T,{modelValue:o(s).giftActivityType,"onUpdate:modelValue":e[0]||(e[0]=u=>o(s).giftActivityType=u),onChange:ye},{default:a(()=>[i(g,{value:"BUY_GIFT",disabled:o(n)},{radio:a(({checked:u})=>[i(d,{align:"start",class:B(["custom-radio-card",{"custom-radio-card-checked":u}])},{default:a(()=>[e[11]||(e[11]=m("div",{className:"custom-radio-card-mask"},[m("div",{className:"custom-radio-card-mask-dot"})],-1)),m("div",null,[e[10]||(e[10]=m("div",{className:"custom-radio-card-title"}," 买赠 ",-1)),i(t,{type:"secondary"},{default:a(()=>e[9]||(e[9]=[c(" 下单即送赠品，买A送abc，买B送4a2b3c，用赠品促进商品的成交转化 ")])),_:1})])]),_:2},1032,["class"])]),_:1},8,["disabled"]),i(g,{value:"FULL_PRICE",disabled:o(n)},{radio:a(({checked:u})=>[i(d,{align:"start",class:B(["custom-radio-card",{"custom-radio-card-checked":u}])},{default:a(()=>[e[14]||(e[14]=m("div",{className:"custom-radio-card-mask"},[m("div",{className:"custom-radio-card-mask-dot"})],-1)),m("div",null,[e[13]||(e[13]=m("div",{className:"custom-radio-card-title"}," 满N元赠 ",-1)),i(t,{type:"secondary"},{default:a(()=>e[12]||(e[12]=[c(" 同一商品或跨商品购买金额满足门槛可得赠品，提客单价效果超好 ")])),_:1})])]),_:2},1032,["class"])]),_:1},8,["disabled"]),i(g,{value:"FULL_COUNT",disabled:o(n)},{radio:a(({checked:u})=>[i(d,{align:"start",class:B(["custom-radio-card",{"custom-radio-card-checked":u}])},{default:a(()=>[e[17]||(e[17]=m("div",{className:"custom-radio-card-mask"},[m("div",{className:"custom-radio-card-mask-dot"})],-1)),m("div",null,[e[16]||(e[16]=m("div",{className:"custom-radio-card-title"}," 满N件赠 ",-1)),i(t,{type:"secondary"},{default:a(()=>e[15]||(e[15]=[c(" 同一商品或跨商品购买件数满足门槛可得总价赠品，可用于库存清仓等场景 ")])),_:1})])]),_:2},1032,["class"])]),_:1},8,["disabled"])]),_:1},8,["modelValue"])]),i(L,{field:"promotionName",label:"活动名称",rules:[o(E)]},{default:a(()=>[i(A,{modelValue:o(s).promotionName,"onUpdate:modelValue":e[1]||(e[1]=u=>o(s).promotionName=u),"allow-clear":"",style:{width:"400px"},disabled:o(n)},null,8,["modelValue","disabled"])]),_:1},8,["rules"]),i(L,{field:"rangeTime",label:"活动时间",rules:[o(E)]},{default:a(()=>[i(Ne,{modelValue:o(s).rangeTime,"onUpdate:modelValue":e[2]||(e[2]=u=>o(s).rangeTime=u),style:{width:"400px","margin-bottom":"20px"},disabled:o(n),"show-time":"",format:"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue","disabled"])]),_:1},8,["rules"])]),m("div",De,[i(L,{field:"scopeType",label:"使用范围",rules:[o(E)]},{default:a(()=>[i(T,{modelValue:o(s).scopeType,"onUpdate:modelValue":e[3]||(e[3]=u=>o(s).scopeType=u)},{default:a(()=>[i(g,{value:"ALL",disabled:o(n)},{default:a(()=>e[18]||(e[18]=[c(" 全店参与 ")])),_:1},8,["disabled"]),i(g,{value:"PORTION_GOODS",disabled:o(n)},{default:a(()=>e[19]||(e[19]=[c(" 部分商品参与 ")])),_:1},8,["disabled"])]),_:1},8,["modelValue"])]),_:1},8,["rules"]),o(s).scopeType==="PORTION_GOODS"&&o(s).promotionStatus==="NEW"?(r(),v(L,{key:0,style:{width:"100%"}},{default:a(()=>[o(s).promotionStatus==="NEW"?(r(),C("div",Ee,[m("div",Ye,[i(I,{disabled:o(n),type:"outline",onClick:e[4]||(e[4]=u=>Z("PROMOTION"))},{default:a(()=>e[20]||(e[20]=[c(" 选择商品 ")])),_:1},8,["disabled"])])])):p("",!0)]),_:1})):p("",!0),o(s).scopeType==="PORTION_GOODS"?(r(),v(L,{key:1},{default:a(()=>[i(te,{"selected-keys":o(V),"onUpdate:selectedKeys":e[5]||(e[5]=u=>ue(V)?V.value=u:null),columns:re,data:o(O),"row-selection":o(K),"row-key":"skuId",pagination:!1,style:{width:"100%"}},{Optiona:a(({rowIndex:u})=>[i(I,{type:"text",status:"danger",disabled:o(n),onClick:k=>X("PROMOTION",u)},{default:a(()=>e[21]||(e[21]=[c(" 删除 ")])),_:2},1032,["disabled","onClick"])]),_:1},8,["selected-keys","data","row-selection"])]),_:1})):p("",!0),o(s).giftActivityType==="BUY_GIFT"?(r(),C("div",Pe,[i(L,{style:{width:"100%"},label:"活动赠品"},{default:a(()=>[o(s).promotionStatus==="NEW"?(r(),C("div",Me,[m("div",xe,[i(I,{disabled:o(n),type:"outline",onClick:e[6]||(e[6]=u=>Z("GIFT"))},{default:a(()=>e[22]||(e[22]=[c(" 选择赠品 ")])),_:1},8,["disabled"])])])):p("",!0)]),_:1}),i(L,null,{default:a(()=>[i(te,{"selected-keys":o(V),"onUpdate:selectedKeys":e[7]||(e[7]=u=>ue(V)?V.value=u:null),columns:me,data:o(f),"row-selection":o(K),"row-key":"skuId",pagination:!1,style:{width:"100%"}},{giftNum:a(({record:u,rowIndex:k})=>[i(D,{modelValue:u.giftNum,"onUpdate:modelValue":h=>u.giftNum=h,disabled:o(n)||l.promotionStatus==="START",min:1,onInput:h=>ve(h,k)},null,8,["modelValue","onUpdate:modelValue","disabled","onInput"])]),packageNum:a(({record:u,rowIndex:k})=>[k===0?(r(),v(D,{key:0,modelValue:u.packageNum,"onUpdate:modelValue":h=>u.packageNum=h,disabled:o(n)||l.promotionStatus==="START",min:1,onInput:h=>ke(h,k)},null,8,["modelValue","onUpdate:modelValue","disabled","onInput"])):p("",!0)]),Optiona:a(({rowIndex:u})=>[i(I,{type:"text",status:"danger",disabled:o(n),onClick:k=>X("GIFT",u)},{default:a(()=>e[23]||(e[23]=[c(" 删除 ")])),_:2},1032,["disabled","onClick"])]),_:1},8,["selected-keys","data","row-selection"])]),_:1})])):p("",!0),o(s).giftActivityType!=="BUY_GIFT"?(r(),C("div",Be,[o(n)?p("",!0):(r(),v(L,{key:0,label:""},{default:a(()=>[i(I,{type:"primary",disabled:o(n)||o(s).rulesItems.length>=3,onClick:ce},{default:a(()=>[c(" 新增阶梯 ("+q(o(s).rulesItems.length)+"/3) ",1)]),_:1},8,["disabled"])]),_:1})),(r(!0),C(de,null,ne(o(s).rulesItems,(u,k)=>{var h;return r(),C("div",{key:k},[i(L,{field:"discountType",label:"",rules:[o(E)]},{default:a(()=>[o(s).giftActivityType==="FULL_PRICE"?(r(),v(oe,{key:0},{default:a(()=>{var y;return[e[27]||(e[27]=m("span",{"mr-2":""},"满",-1)),i(A,{modelValue:u.consumeThreshold,"onUpdate:modelValue":G=>u.consumeThreshold=G,disabled:o(n),style:{width:"160px"},placeholder:"请输入金额"},{append:a(()=>e[24]||(e[24]=[c(" 元 ")])),_:2},1032,["modelValue","onUpdate:modelValue","disabled"]),e[28]||(e[28]=m("span",{"ml-8px":""},"送赠品",-1)),o(n)?p("",!0):(r(),v(I,{key:0,disabled:((y=o(s).rulesItems[k])==null?void 0:y.giftList.length)>=10,"ml-8px":"",type:"text",onClick:G=>ee("LADDER_GIFT",k)},{default:a(()=>e[25]||(e[25]=[c(" 添加赠品 ")])),_:2},1032,["disabled","onClick"])),o(n)?p("",!0):(r(),v(I,{key:1,"ml-8":"",type:"primary",disabled:o(n)||o(s).rulesItems.length<=1,onClick:G=>z(k)},{default:a(()=>e[26]||(e[26]=[c(" 删除 ")])),_:2},1032,["disabled","onClick"]))]}),_:2},1024)):p("",!0),o(s).giftActivityType==="FULL_COUNT"?(r(),v(oe,{key:1},{default:a(()=>{var y;return[e[32]||(e[32]=m("span",{"mr-2":""},"满",-1)),i(D,{modelValue:u.countThreshold,"onUpdate:modelValue":G=>u.countThreshold=G,disabled:o(n),style:{width:"160px"},placeholder:"请输入件数",precision:0,min:1},{append:a(()=>e[29]||(e[29]=[c(" 件 ")])),_:2},1032,["modelValue","onUpdate:modelValue","disabled"]),e[33]||(e[33]=m("span",{"ml-8px":""},"送赠品",-1)),o(n)?p("",!0):(r(),v(I,{key:0,disabled:((y=o(s).rulesItems[k])==null?void 0:y.giftList.length)>=10,"ml-8px":"",type:"text",onClick:G=>ee("LADDER_GIFT",k)},{default:a(()=>e[30]||(e[30]=[c(" 添加赠品 ")])),_:2},1032,["disabled","onClick"])),o(n)?p("",!0):(r(),v(I,{key:1,"ml-8":"",type:"primary",disabled:o(n)||o(s).rulesItems.length<=1,onClick:G=>z(k)},{default:a(()=>e[31]||(e[31]=[c(" 删除 ")])),_:2},1032,["disabled","onClick"]))]}),_:2},1024)):p("",!0)]),_:2},1032,["rules"]),(r(!0),C(de,null,ne((h=o(s).rulesItems[k])==null?void 0:h.giftList,(y,G)=>{var ae;return r(),C("div",{key:G},[(ae=o(s).rulesItems[k])!=null&&ae.giftList?(r(),v(L,{key:0,field:"goods",label:""},{default:a(()=>[y!=null&&y.thumbnail?(r(),v(Te,{key:0,width:80,src:y==null?void 0:y.thumbnail},null,8,["src"])):p("",!0),m("span",qe,q(y==null?void 0:y.goodsName),1),i(D,{modelValue:y.stockNum,"onUpdate:modelValue":ie=>y.stockNum=ie,"ml-8px":"",disabled:o(n),style:{width:"160px"},placeholder:"请输入赠品数量",precision:0,min:1},{append:a(()=>e[34]||(e[34]=[c(" 件 ")])),_:2},1032,["modelValue","onUpdate:modelValue","disabled"]),o(n)?p("",!0):(r(),v(I,{key:1,"ml-8":"",type:"primary",onClick:ie=>ge(G)},{default:a(()=>e[35]||(e[35]=[c(" 删除 ")])),_:2},1032,["onClick"]))]),_:2},1024)):p("",!0)])}),128))])}),128)),o(N)?(r(),v(L,{key:1,label:""},{default:a(()=>[m("span",$e,q(o(N)),1)]),_:1})):p("",!0)])):p("",!0),m("div",null,[i(I,{style:{"margin-right":"5px"},onClick:e[8]||(e[8]=u=>o(H).push({name:"gift"}))},{default:a(()=>e[36]||(e[36]=[c(" 返回 ")])),_:1}),o(n)?p("",!0):(r(),v(I,{key:0,type:"primary",disabled:o(n),onClick:fe},{default:a(()=>e[37]||(e[37]=[c(" 提交 ")])),_:1},8,["disabled"]))])])])]),_:1},8,["model"])]),_:1}),i(o(M),{ref_key:"skuSelect",ref:j,"goods-or-sku":!0,"default-goods-selected-list":o(O),api:o(P),onChange:Y},null,8,["default-goods-selected-list","api"]),o(s).giftActivityType==="BUY_GIFT"?(r(),v(o(M),{key:0,ref_key:"giftSelect",ref:W,"goods-or-sku":!0,"default-goods-selected-list":o(f),api:o(P),onChange:Y},null,8,["default-goods-selected-list","api"])):p("",!0),o(s).giftActivityType!=="BUY_GIFT"?(r(),v(o(M),{key:1,ref_key:"ladderSelect",ref:J,"goods-or-sku":!0,"default-goods-selected-list":(le=(se=o(s))==null?void 0:se.rulesItems[o(S)])==null?void 0:le.giftList,api:o(P),onChange:Y},null,8,["default-goods-selected-list","api"])):p("",!0)])}}}),Ze=Re(He,[["__scopeId","data-v-ba35e401"]]);export{Ze as default};
