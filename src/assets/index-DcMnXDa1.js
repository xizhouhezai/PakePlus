import{d as fe,r as p,a as ce,h as me,b as f,o as h,j as w,w as a,e as o,f as d,u as i,bf as pe,t as N,k as g,q as C,s as M,c as G,F as ve,i as ge,M as b,bs as be,bt as _e,bu as H,bv as he,bj as ye,bw as ke,_ as Se}from"./index-C4AMdMz2.js";import{u as we}from"./useCurrentInstance-BLlvmEjv.js";import{R as xe,V as Ee}from"./validator-B8pIxTAL.js";import{V as Re}from"./dist-PezRi_EG.js";const Ve={"w-full":"",flex:"","items-end":"","justify-between":""},Ie={flex:"","flex-col":"","items-end":""},Ce={class:"btns"},Me={class:"role-list"},Ae={class:"title"},Pe={class:"content"},Ue=fe({__name:"index",setup(Oe){var F;const y=p(),k=p(""),x=p([]),T=p(),A=p(""),S=p(!1),E=p(!1),_=p([]),v=p([]),R=p(""),m=p([]),P=p(),j=(F=we().globalProperties)==null?void 0:F.$modal,Q=[{title:"角色名称",dataIndex:"name",width:200},{title:"备注",dataIndex:"description",width:200},{title:"创建时间",dataIndex:"createTime",width:300},{title:"更新时间",dataIndex:"updateTime",width:300},{title:"最后操作人",dataIndex:"createBy",width:300}],J={title:"操作",width:300,fixed:"right",methods:[{title:"编辑",callback:"editor-event",type:"text",status:"warning"},{title:"删除",callback:"delete",type:"text",status:"danger"}]};function X(l,e){if(e.level===0){const s=_.value.find(c=>e.menuId===c.id).children;if(s.length){const c=s.map(u=>u.id);v.value.forEach(u=>{c.includes(u.menuId)&&(u.isSuper=l)}),b.success(`已将${e.title}下所有子集权限设置为${l?"操作":"查看"}权限`)}}}const r=ce({enableAddModal:!1,formLoading:!1,fid:"",form:{name:"",description:""}});function Y(l){x.value=l}function Z(){r.enableAddModal=!0,k.value="添加",r.fid="",r.id="",R.value="",Object.keys(r.form).forEach(l=>{r.form[l]=""}),m.value=[],U({})}async function ee(){var e;if(!await((e=T.value)==null?void 0:e.validate())){if(v.value.length===0){b.warning("您还未分配菜单权限");return}const s={role:{...r.form},roleMenu:v.value.map(u=>({isSuper:u.isSuper,menuId:u.menuId,roleId:u.roleId,title:u.title}))};let c;r.fid?c=await _e(r.fid,s):c=await be(s),c.data.success&&(b.success(`${r.fid?"修改":"添加"}成功!`),r.enableAddModal=!1,y.value.init())}}function te(l){k.value="编辑",l&&(Object.keys(l.record).forEach(e=>{r.form.hasOwnProperty(e)&&(r.form[e]=l.record[e])}),r.fid=l.record.id,r.enableAddModal=!0,U(l))}function le(l){j.confirm({title:"确认删除",content:"您确认要删除么?",alignCenter:!1,onOk:async()=>{(await H(l.record.id)).data.success&&(b.success("删除成功"),y.value.init())}})}function ae(){if(x.value.length<=0){b.error("您还未选择要删除的数据");return}x.value.forEach(e=>{A.value+=`${e.id},`});const l=A.value.substring(0,A.value.length-1);j.confirm({title:"确认删除",content:`您确认要删除所选的${x.value.length}条数据?`,alignCenter:!1,onOk:async()=>{(await H(l)).data.success&&(b.success("删除成功"),y.value.init())}})}function ne(l,e){if(!e)return!1;let t=!1;for(let s=0;s<e.length;s+=1)if(l.id===e[s].menuId){l.isSuper=e[s].isSuper,t=!0;break}return!!t}function B(l,e){l.forEach(t=>{ne(t,e)&&t.status!==-1?t.children&&t.children.length===0&&(t.checked=!0):t.checked=!1,t.children&&t.children.length>0&&B(t.children,e)})}async function U(l){_.value.forEach(s=>{s.children.length!==0&&s.children.forEach(c=>{c.children.length!==0&&c.children.forEach(u=>{u.key=u.id,delete u.isSuper}),delete c.isSuper}),delete s.isSuper}),k.value=`分配${l.record.name}的菜单权限`,R.value=l.record.id;let e=[];const t=await he(l.record.id);t.data.result&&(e=t.data.result,m.value=t.data.result.map(s=>s.menuId)),B(_.value,e)}function D(){if(!m.value.length){b.error("请选择菜单权限");return}v.value=[],E.value=!0;const l=P.value.getCheckedNodes(),e=[];l.forEach(t=>{const s={title:t.title,isSuper:t.isSuper?t.isSuper=!0:t.isSuper=!1,menuId:t.id,roleId:R.value,level:t.level};e.push(s),v.value=e})}function se(){ye({version:"v3",scene:"MANAGER"}).then(l=>{l.data.success&&(_.value=l.data.result.map(e=>(delete e.icon,e)))})}function z(l){let e=!1;l==="onlyView"?e=!1:e=!0,v.value.forEach(t=>{t.isSuper=e})}function oe(){ke(R.value,{role:r.form,roleMenu:v.value}).then(e=>{e.data.success&&(b.success("操作成功"),y.value.init(),S.value=!1)});const l=v.value.filter(e=>e.isSuper===!0).map(e=>e.menuId);_.value.forEach(e=>{l.includes(e.id)?e.isSuper=!0:(e.isSuper!==""||e.isSuper!==void 0)&&m.value.includes(e.id)&&(e.isSuper=!1),e.children&&e.children.length>0&&e.children.forEach(t=>{l.includes(t.id)?t.isSuper=!0:(t.isSuper!==""||t.isSuper!==void 0)&&m.value.includes(t.id)&&(t.isSuper=!1),t.children&&t.children.length>0&&t.children.forEach(s=>{l.includes(s.id)?s.isSuper=!0:(s.isSuper!==""||s.isSuper!==void 0)&&m.value.includes(s.id)&&(s.isSuper=!1)})})})}return me(()=>{se()}),(l,e)=>{const t=f("a-button"),s=f("a-space"),c=f("a-col"),u=f("a-row"),re=f("a-switch"),K=f("a-input"),V=f("a-form-item"),I=f("a-tag"),W=f("a-tree"),ie=f("a-form"),O=f("a-modal"),q=f("a-radio"),de=f("a-radio-group"),ue=f("a-card");return h(),w(ue,{class:"general-card",title:"角色管理",bordered:!1},{default:a(()=>[o(u,{style:{"margin-bottom":"16px"}},{default:a(()=>[o(c,{span:16},{default:a(()=>[o(s,null,{default:a(()=>[o(t,{type:"primary",onClick:Z},{default:a(()=>e[9]||(e[9]=[d(" 添加 ")])),_:1}),o(t,{onClick:ae},{default:a(()=>e[10]||(e[10]=[d(" 批量删除 ")])),_:1})]),_:1})]),_:1})]),_:1}),o(i(Re),{ref_key:"tablePageRef",ref:y,columns:Q,methods:J,api:i(pe),checkbox:!0,onDelete:le,onEditorEvent:te,onEditPerm:U,onSelectTableChange:Y},{btnList:a(({data:n})=>[o(s,{size:"large"},{default:a(()=>[o(re,{modelValue:n.disabled,"onUpdate:modelValue":L=>n.disabled=L,"checked-value":"OPEN","unchecked-value":"CLOSE"},{checked:a(()=>e[11]||(e[11]=[d(" 启用 ")])),unchecked:a(()=>e[12]||(e[12]=[d(" 禁用 ")])),_:2},1032,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:1},8,["api"]),o(O,{visible:i(r).enableAddModal,"onUpdate:visible":e[3]||(e[3]=n=>i(r).enableAddModal=n),"align-center":!1,footer:!1,"mask-closable":!1},{title:a(()=>[d(N(i(k)),1)]),default:a(()=>[o(ie,{ref_key:"formRef",ref:T,model:i(r).form,onSubmit:ee},{default:a(()=>[o(V,{field:"name",label:"角色名称",rules:[i(xe),i(Ee)],"validate-trigger":["change"]},{default:a(()=>[o(K,{modelValue:i(r).form.name,"onUpdate:modelValue":e[0]||(e[0]=n=>i(r).form.name=n)},null,8,["modelValue"])]),_:1},8,["rules"]),o(V,{field:"code",label:"备注","validate-trigger":["change"]},{default:a(()=>[o(K,{modelValue:i(r).form.description,"onUpdate:modelValue":e[1]||(e[1]=n=>i(r).form.description=n)},null,8,["modelValue"])]),_:1}),o(V,{field:"code",label:"菜单权限","validate-trigger":["change"]},{default:a(()=>[g("div",Ve,[o(W,{ref_key:"treeRef",ref:P,"checked-keys":i(m),"onUpdate:checkedKeys":e[2]||(e[2]=n=>C(m)?m.value=n:null),data:i(_),checkable:!0,multiple:!0,"field-names":{children:"children",title:"title",key:"id"},"only-check-leaf":!0},{extra:a(n=>[n.isSuper===!0?(h(),w(I,{key:0,color:"arcoblue",style:{"margin-left":"10px"}},{default:a(()=>e[13]||(e[13]=[d(" 操作权限 ")])),_:1})):M("",!0),n.isSuper===!1?(h(),w(I,{key:1,color:"green",style:{"margin-left":"10px"}},{default:a(()=>e[14]||(e[14]=[d(" 查看权限 ")])),_:1})):M("",!0)]),_:1},8,["checked-keys","data"]),g("div",Ie,[o(t,{size:"mini",type:"primary",onClick:D},{default:a(()=>e[15]||(e[15]=[d(" 编辑菜单权限 ")])),_:1}),e[16]||(e[16]=g("span",{class:"tips"},"编辑完权限保存后生效",-1))])])]),_:1}),o(V,{label:"操作"},{default:a(()=>[o(t,{loading:i(r).formLoading,"html-type":"submit",type:"primary"},{default:a(()=>e[17]||(e[17]=[d(" 保存 ")])),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])]),_:1},8,["visible"]),o(O,{visible:i(S),"onUpdate:visible":e[5]||(e[5]=n=>C(S)?S.value=n:null),"align-center":!1,onCancel:e[6]||(e[6]=n=>S.value=!1),onOk:D},{title:a(()=>[d(N(i(k)),1)]),default:a(()=>[g("div",null,[o(W,{ref_key:"treeRef",ref:P,"checked-keys":i(m),"onUpdate:checkedKeys":e[4]||(e[4]=n=>C(m)?m.value=n:null),data:i(_),checkable:!0,multiple:!0,"field-names":{children:"children",title:"title",key:"id"},"only-check-leaf":!0},{extra:a(n=>[n.isSuper===!0?(h(),w(I,{key:0,color:"arcoblue",style:{"margin-left":"10px"}},{default:a(()=>e[18]||(e[18]=[d(" 操作权限 ")])),_:1})):M("",!0),n.isSuper===!1?(h(),w(I,{key:1,color:"green",style:{"margin-left":"10px"}},{default:a(()=>e[19]||(e[19]=[d(" 查看权限 ")])),_:1})):M("",!0)]),_:1},8,["checked-keys","data"])])]),_:1},8,["visible"]),o(O,{visible:i(E),"onUpdate:visible":e[8]||(e[8]=n=>C(E)?E.value=n:null),"align-center":!1,title:"选择菜单权限",width:800,onOk:oe},{default:a(()=>[g("div",Ce,[o(t,{class:"btn-item",type:"outline",onClick:z},{default:a(()=>e[20]||(e[20]=[d(" 一键选中·数据权限 ")])),_:1}),o(t,{class:"btn-item",type:"outline",onClick:e[7]||(e[7]=n=>z("onlyView"))},{default:a(()=>e[21]||(e[21]=[d(" 一键选中·查看权限 ")])),_:1})]),g("div",Me,[(h(!0),G(ve,null,ge(i(v),(n,L)=>(h(),G("div",{key:L,class:"role-item"},[g("div",Ae,N(n.title),1),g("div",Pe,[o(de,{modelValue:n.isSuper,"onUpdate:modelValue":$=>n.isSuper=$,type:"button",onChange:$=>X($,n)},{default:a(()=>[o(q,{value:!0},{default:a(()=>e[22]||(e[22]=[d(" 操作数据权限 ")])),_:1}),o(q,{value:!1},{default:a(()=>e[23]||(e[23]=[d(" 查看权限 ")])),_:1})]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"])])]))),128))])]),_:1},8,["visible"])]),_:1})}}}),je=Se(Ue,[["__scopeId","data-v-877cc606"]]);export{je as default};
