import{u as Ue,r as ze,d as Ae,g as Ee,a as Ke,b as $e,c as Be}from"./index--a7kHzzJ.js";import{d as Me,r as c,J as Oe,E as Le,h as Pe,b as d,o as y,j as C,w as t,e as a,u as l,k as p,a9 as ae,s as R,aa as oe,f as v,t as V,q as h,c as A,i as ne,F as se,ab as je,M as D,ac as Ge,_ as He}from"./index-C4AMdMz2.js";import{u as qe}from"./useCurrentInstance-BLlvmEjv.js";import{R as E}from"./validator-B8pIxTAL.js";import{U as Je,H as Qe}from"./dist-PezRi_EG.js";import ie from"./extra-5DUayDl9.js";const We={class:"file-list"},Xe={class:"btnBox"},Ye={class:"pic-list"},Ze={class:"search-box"},el={class:"img-box"},ll={class:"text"},tl={class:"img-box"},al={class:"text"},ol={class:"pagination-box"},nl={style:{"text-align":"right"}},sl={style:{"text-align":"right"}},il=Me({__name:"index",props:{templateModel:{type:String,default:"normal"},closeModel:{type:null},isSingle:{type:Boolean,default:!1},size:{type:Number,default:20}},emits:["changOssImage","selected"],setup(H,{emit:re}){var Z;const _=H,ue=c(Oe.getAccessToken()),K=c([]),x=c(!1),U=c("ADD"),m=c({id:"0",directoryName:""}),q=c(),S=c("0"),de=_.templateModel==="normal",J=(Z=qe().globalProperties)==null?void 0:Z.$modal,Q=c(),F=c(!1),k=c({name:"",fileKey:"",id:"",oldKey:""}),r=c({fileType:"",pageSize:_.size,sort:"createTime",order:"desc",startTime:"",endTime:"",title:"",total:0,current:1,fileDirectoryId:""}),$=c([]),T=c(""),W=c([]),ce=c(""),fe=re,f=c(_.isSingle?null:[]),N=c([]),B=c(!1),M=c({}),pe=[{label:"图片名称",model:"name",disabled:!1,input:!0}];async function b(n=r.value,e=""){const s=await je(n);if(s.data.success){s.data.result.records.forEach(g=>{g.selected=!1}),N.value=s.data.result.records.map(g=>(g.isShowPreview=!1,g));const{current:i,size:u,total:I}=s.data.result;r.value.current=i,r.value.pageSize=u,r.value.total=I,e==="refresh"&&D.success("刷新成功！")}}function me(n){r.value={...r.value,pageNumber:n},b()}function X(){let n="";_.isSingle?n=N.value.find(e=>e.id===f.value):n=N.value.filter(e=>f.value.includes(e.id)),fe("selected",n)}async function ve(){var s;const n={id:k.value.id,key:ce.value,newKey:k.value.fileKey,newName:k.value.name};await((s=Q.value)==null?void 0:s.validate())||(await ze(n)).data.success&&(D.success("操作成功"),F.value=!1)}function ge(){if(!(_.isSingle?!!f.value:f.value.length>0)){D.warning("您还未选择要删除的数据");return}const e=_.isSingle?1:f.value.length,s=`您确认要删除所选的${_.isSingle?"":`${e}个`}文件?`;J.confirm({title:"确认删除",content:s,alignCenter:!1,onOk:async()=>{try{const u={ids:_.isSingle?f.value:f.value.join(",")};(await Ae(u)).data.success&&(D.success("删除文件成功"),f.value=[],await b())}catch(i){console.error("删除文件失败:",i),D.error("删除文件失败，请稍后重试")}}})}function O(n=[],e){const s=[];return n&&n.length!==0&&n.forEach(i=>{const u={};u.title=i.directoryName,u.key=i.id,u.type=i.directoryType,u.label=i.directoryName,u.level=i.level,u.expand=!1,u.selected=!1,u.contextmenu=!0,u.parentId=i.parentId,u.children=O(i.children,e),u.disabled=e?i.level===e:!1,u.icon=()=>Ge(ae),s.push(u)}),s}function L(){Ee().then(n=>{if(n.data.success){K.value=O(n.data.result),$.value=O(n.data.result,2),n.data.result.length&&Y(n.data.result);const e={title:"全部图片",label:"全部图片",value:"0",level:0,children:[],disabled:!1,id:"0",categoryId:0,key:"0"};K.value.unshift(e),$.value.unshift(e)}})}function _e(n){x.value=!0,U.value=n,T.value?(S.value=T.value.key,m.value.parentId=T.value.key):(S.value="0",m.value.parentId="0"),m.value.directoryName=""}function ye(n){m.value.parentId=n.value}function Y(n){n.forEach(e=>{e.children&&Y(e.children),W.value.push(e)})}async function be(){var e;if(!await((e=q.value)==null?void 0:e.validate())){const s={...m.value};if(s.parentId==="0")s.level=0;else{const u=W.value.find(I=>I.id===s.parentId).level;s.level=u+1}let i;U.value==="ADD"?(delete s.id,i=await Ke(s)):i=await $e(s),i.data.success&&(x.value=!1,L())}}function ke(n){J.confirm({title:"确认删除",content:"是否删除该分组？",alignCenter:!1,onOk:async()=>{Be(n).then(e=>{e.data.success&&(D.success("删除成功！"),L())})}})}function xe(n,e){n==="edit"&&(x.value=!0,U.value="EDIT",m.value.directoryName=e.label,m.value.id=e.key,m.value.level=e.level,m.value.parentId=e.parentId,S.value=e.parentId),n==="delete"&&ke(e.key)}function Se(n,e){const s=n[0];T.value=e.node,r.value.fileDirectoryId=s,r.value.parentId=e.node.parentId,s==="0"&&delete r.value.fileDirectoryId,b()}return Le(()=>[r.value],()=>{b()},{deep:!0}),Pe(()=>{L(),b()}),(n,e)=>{const s=d("icon-more"),i=d("a-doption"),u=d("a-dropdown"),I=d("a-tree"),g=d("a-button"),ee=d("a-col"),we=d("a-checkbox"),le=d("a-tooltip"),Ie=d("a-checkbox-group"),Ce=d("a-radio"),Ve=d("a-radio-group"),he=d("a-pagination"),De=d("a-row"),P=d("a-input"),z=d("a-form-item"),te=d("a-form"),j=d("a-modal"),Fe=d("a-tree-select"),Te=d("a-image"),Ne=d("a-card");return y(),C(Ne,{class:"general-card",title:"素材管理",bordered:!1},{default:t(()=>[a(l(Je),{"row-span":de?0:12,columns:pe,onReset:e[0]||(e[0]=o=>{r.value={...l(r),...o}}),onSearch:e[1]||(e[1]=o=>{r.value={...l(r),...o}})},null,8,["row-span"]),a(De,{class:"oss-manage"},{default:t(()=>[a(ee,{span:6},{default:t(()=>[p("div",We,[a(I,{data:l(K),onSelect:Se},{"switcher-icon":t((o,{isLeaf:w})=>[o.key==="0"?(y(),C(l(ae),{key:0})):R("",!0),w?R("",!0):(y(),C(l(oe),{key:1}))]),extra:t(o=>[o.key!=="0"?(y(),C(u,{key:0,onSelect:w=>xe(w,o)},{content:t(()=>[a(i,{value:"edit"},{default:t(()=>e[18]||(e[18]=[v(" 编辑 ")])),_:1}),a(i,{value:"delete"},{default:t(()=>e[19]||(e[19]=[v(" 删除 ")])),_:1})]),default:t(()=>[a(s,{style:{position:"absolute",right:"16px","font-size":"22px",top:"5px",color:"#999999"}})]),_:2},1032,["onSelect"])):R("",!0)]),_:1},8,["data"]),p("div",Xe,[a(g,{disabled:l(T).level===2,long:"",onClick:e[2]||(e[2]=o=>_e("ADD"))},{default:t(()=>e[20]||(e[20]=[v(" 添加分组 ")])),_:1},8,["disabled"])])])]),_:1}),a(ee,{span:18},{default:t(()=>[p("div",Ye,[p("div",Ze,[a(u,{"popup-max-height":!1},{content:t(()=>[a(i,{onClick:e[3]||(e[3]=()=>b(l(r),"refresh"))},{default:t(()=>e[22]||(e[22]=[v(" 刷新 ")])),_:1}),a(i,{onClick:ge},{default:t(()=>[v(V(H.isSingle?"删除":"批量删除"),1)]),_:1})]),default:t(()=>[a(g,null,{default:t(()=>[e[21]||(e[21]=v(" 更多操作 ")),a(l(oe))]),_:1})]),_:1}),a(l(Qe),{api:l(Ue),"access-token":l(ue),"api-params":{directoryPath:l(r).fileDirectoryId},style:{"margin-left":"20px"},onOnSuccess:e[4]||(e[4]=()=>b(l(r)))},null,8,["api","access-token","api-params"])]),_.isSingle?R("",!0):(y(),C(Ie,{key:0,modelValue:l(f),"onUpdate:modelValue":e[6]||(e[6]=o=>h(f)?f.value=o:null),onChange:X},{default:t(()=>[p("div",el,[(y(!0),A(se,null,ne(l(N),(o,w)=>(y(),A("div",{key:w,class:"img-item"},[a(we,{value:o.id},{checkbox:t(({checked:G})=>[a(ie,{res:o,checked:G,onReload:e[5]||(e[5]=Re=>b(l(r)))},null,8,["res","checked"])]),_:2},1032,["value"]),p("div",ll,[a(le,{content:o.name},{default:t(()=>[p("div",null,V(o.name),1)]),_:2},1032,["content"])])]))),128))])]),_:1},8,["modelValue"])),_.isSingle?(y(),C(Ve,{key:1,modelValue:l(f),"onUpdate:modelValue":e[8]||(e[8]=o=>h(f)?f.value=o:null),onChange:X},{default:t(()=>[p("div",tl,[(y(!0),A(se,null,ne(l(N),(o,w)=>(y(),A("div",{key:w,class:"img-item"},[a(Ce,{value:o.id},{radio:t(({checked:G})=>[a(ie,{res:o,checked:G,onReload:e[7]||(e[7]=Re=>b(l(r)))},null,8,["res","checked"])]),_:2},1032,["value"]),p("div",al,[a(le,{content:o.name},{default:t(()=>[p("div",null,V(o.name),1)]),_:2},1032,["content"])])]))),128))])]),_:1},8,["modelValue"])):R("",!0),p("div",ol,[a(he,{current:l(r).current,total:l(r).total,"page-size":l(r).pageSize,onChange:me},null,8,["current","total","page-size"])])])]),_:1})]),_:1}),a(j,{visible:l(F),"onUpdate:visible":e[12]||(e[12]=o=>h(F)?F.value=o:null),width:550},{title:t(()=>e[23]||(e[23]=[v(" 编辑文件名 ")])),footer:t(()=>[p("div",nl,[a(g,{style:{"margin-right":"5px"},onClick:e[11]||(e[11]=o=>F.value=!1)},{default:t(()=>e[24]||(e[24]=[v(" 取消 ")])),_:1}),a(g,{type:"primary",onClick:ve},{default:t(()=>e[25]||(e[25]=[v(" 提交 ")])),_:1})])]),default:t(()=>[a(te,{ref_key:"formRef",ref:Q,model:l(k)},{default:t(()=>[a(z,{field:"name",label:"原文件名",rules:[l(E)]},{default:t(()=>[a(P,{modelValue:l(k).name,"onUpdate:modelValue":e[9]||(e[9]=o=>l(k).name=o)},null,8,["modelValue"])]),_:1},8,["rules"]),a(z,{field:"fileKey",label:"存储文件名",rules:[l(E)]},{default:t(()=>[a(P,{modelValue:l(k).fileKey,"onUpdate:modelValue":e[10]||(e[10]=o=>l(k).fileKey=o),disabled:""},null,8,["modelValue"])]),_:1},8,["rules"])]),_:1},8,["model"])]),_:1},8,["visible"]),a(j,{visible:l(x),"onUpdate:visible":e[16]||(e[16]=o=>h(x)?x.value=o:null),width:500},{title:t(()=>[v(V(l(U)==="ADD"?"添加分组":"编辑分组"),1)]),footer:t(()=>[p("div",sl,[a(g,{style:{"margin-right":"5px"},onClick:e[15]||(e[15]=o=>x.value=!1)},{default:t(()=>e[26]||(e[26]=[v(" 取消 ")])),_:1}),a(g,{type:"primary",onClick:be},{default:t(()=>e[27]||(e[27]=[v(" 提交 ")])),_:1})])]),default:t(()=>[a(te,{ref_key:"groupFormRef",ref:q,model:l(m)},{default:t(()=>[a(z,{field:"id",label:"所在分组",rules:[l(E)]},{default:t(()=>[a(Fe,{"model-value":l(S),"onUpdate:modelValue":e[13]||(e[13]=o=>h(S)?S.value=o:null),data:l($),"label-in-value":!0,"default-value":l(S),placeholder:"Please select ...","tree-checked-strategy":"all",onChange:ye},null,8,["model-value","data","default-value"])]),_:1},8,["rules"]),a(z,{field:"directoryName",label:"分组名称",rules:[l(E)]},{default:t(()=>[a(P,{modelValue:l(m).directoryName,"onUpdate:modelValue":e[14]||(e[14]=o=>l(m).directoryName=o)},null,8,["modelValue"])]),_:1},8,["rules"])]),_:1},8,["model"])]),_:1},8,["visible"]),a(j,{visible:l(B),"onUpdate:visible":e[17]||(e[17]=o=>h(B)?B.value=o:null),title:"查看图片",draggable:""},{footer:t(()=>[p("span",null,"文件类型："+V(l(M).fileType)+" 文件大小："+V(l(M).msize),1)]),default:t(()=>[a(Te,{src:l(M).url,width:"100%",alt:"无效的图片链接"},null,8,["src"])]),_:1},8,["visible"])]),_:1})}}}),ml=He(il,[["__scopeId","data-v-b42c46b2"]]);export{ml as default};
