import{x as ee}from"./goods-CB7YWqUH.js";import{r as te}from"./promotion-ChRoyrm_.js";import{R}from"./validator-B8pIxTAL.js";import{I as le}from"./dist-PezRi_EG.js";import{d as se,r as I,p as ae,n as oe,af as L,a as de,h as ue,E as ie,b,o as p,c as D,e as d,w as a,u as t,k as r,Z as _,f as m,j as v,s as y,F as re,i as ne,t as pe,q as me,M as C,_ as fe}from"./index-C4AMdMz2.js";const ye={class:"base-info-item"},ve={class:"form-item-view"},ce={style:{"margin-top":"20px","margin-bottom":"20px"}},Te={class:"errorMessage"},be={class:"form-item-view"},ge={key:0,style:{display:"flex"}},ke={style:{display:"flex","margin-bottom":"10px"}},Ne=se({__name:"full-discount-detail",setup(Ie){const M=I(),c=I(""),x=ae(),G=oe(),g=I(!0),u=I("true"),Y=I(null),V=I([]),l=I({promotionName:"",rangeTime:[L().format("YYYY-MM-DD HH:mm:ss"),L().add(1,"month").format("YYYY-MM-DD HH:mm:ss")],description:"",fullMoney:"",discountType:"RATE",fullMinus:"",fullRate:"",promotionStatus:"NEW",couponId:"",giftId:"",points:0,scopeType:"ALL",promotionGoodsList:[],fullThreshold:0,activeType:"",discountWay:"PRICE",rulesItems:[{priceNum:"",rateNum:"",price:"",rate:""}]}),F=[{title:"商品名称",dataIndex:"goodsName"},{title:"商品价格",dataIndex:"price",currency:!0},{title:"库存",dataIndex:"quantity"},{title:"操作",slotName:"Optiona"}],W=de({type:"checkbox",showCheckedAll:!0,onlyCurrent:!0}),A=I([]),H=I([]);async function q(){const i=await te(x.query.id);if(i.data.success){const e=i.data.result;e.scopeType==="ALL"&&(e.promotionGoodsList=[]),e.rangeTime=[],e.rangeTime.push(e.startTime,e.endTime),l.value=e,e.discountType==="PRICE"&&(l.value.rulesItems=JSON.parse(e.discountRules).map(s=>({priceNum:s.num,price:s.price}))),e.discountType==="RATE"&&(l.value.rulesItems=JSON.parse(e.discountRules).map(s=>({rateNum:s.num,rate:s.rate}))),c.value="",V.value=e.promotionGoodsList}}async function J(){if(l.value.rulesItems.length>=3)return C.error("最多设置3个促销规则"),!1;l.value.rulesItems.push({priceNum:"",rateNum:"",price:"",rate:""})}async function P(i){if(l.value.rulesItems.length<=1)return C.error("最少设置1个促销规则"),!1;l.value.rulesItems.splice(i,1)}function U(){G.push({name:"full-discount"})}async function B(){var e;if(!await((e=M.value)==null?void 0:e.validate())){if(l.value.activeType==="CROSS"&&!g.value)return;const s=JSON.parse(JSON.stringify(l.value));if(s.promotionGoodsList=V.value,s.startTime=l.value.rangeTime[0],s.endTime=l.value.rangeTime[1],s.scopeType==="PORTION_GOODS"&&(!s.promotionGoodsList||s.promotionGoodsList.length===0)){C.warning("请选择指定商品");return}if(s.scopeType==="ALL")delete s.promotionGoodsList,s.number=-1;else{const n=[];s.number=1,s.promotionGoodsList.forEach(f=>{f.startTime=s.startTime,f.endTime=s.endTime,n.push(f.skuId)}),s.scopeId=n.toString()}if(s.discountType==="fullMinusFlag"?s.fullMinusFlag=!0:s.fullRateFlag=!0,s.giftFlag&&H.value.forEach(n=>{s.giftId===n.id&&(s.giftSkuId=n.id,s.giftSkuName=n.goodsName,s.giftSkuThumbnail=n.thumbnail)}),delete s.rangeTime,s.discountType!=="DIY"&&delete s.discountWay,s.discountType==="PRICE"){const n=s.rulesItems.map(f=>({num:f.priceNum,price:f.price}));s.discountRules=JSON.stringify(n)}else if(s.discountType==="RATE"){const n=s.rulesItems.map(f=>({num:f.rateNum,rate:f.rate}));s.discountRules=JSON.stringify(n)}x.query.id?(delete s.updateTime,editFullDiscount(s).then(n=>{n.data.success&&(C.success("编辑活动成功"),U())})):(delete s.id,newFullDiscount(s).then(n=>{n&&n.data&&n.data.success&&(C.success("添加活动成功"),U())}))}}function $(){Y.value.modalData.visible=!0}function j(i){const e=[];i.forEach(s=>{const n={settlementPrice:s.settlementPrice||0,pointsGoodsCategoryId:s.pointsGoodsCategoryId||0,pointsGoodsCategoryName:s.pointsGoodsCategoryName||"",activeStock:s.activeStock||0,points:s.points||0,skuId:s.id,goodsId:s.goodsId,originalPrice:s.price||0,thumbnail:s.thumbnail||"",goodsName:s.goodsName||"",quantity:s.quantity||"",storeName:s.storeName||"",price:s.price||""};e.push(n)}),V.value=e}function z(i){V.value.splice(i,1)}function K(i){i==="CROSS"&&(l.value.discountType="RATE",l.value.scopeType="ALL",l.value.rulesItems=[{priceNum:"",rateNum:"",price:"",rate:""}]),i==="SAME"&&(l.value.discountType="HALF",l.value.scopeType="PORTION_GOODS",c.value="")}return ue(async()=>{x.query.id?q():l.value.activeType="CROSS",c.value="";const i=L().format("YYYYMMDD HH:mm:ss");l.value.promotionName=`多件优惠-${i}`}),ie(()=>l.value.rulesItems,i=>{if(i)for(let e=0;e<i.length;e++){if(l.value.discountType==="PRICE"){if(!i[e].priceNum){c.value="【满件】不可为空",g.value=!1;return}if(!i[e].price){c.value="【金额】不可为空",g.value=!1;return}if(e<i.length-1){const s=i[e],n=i[e+1];if(s.priceNum&&s.priceNum>=n.priceNum){c.value="下一个层级的【满件】需要大于上一个层级的【满件】",g.value=!1;return}if(s.price&&s.price>=n.price){c.value="下一个层级的【优惠力度】要大于上一个层级的【优惠力度】",g.value=!1;return}}}else if(l.value.discountType==="RATE"){if(!i[e].rateNum){c.value="【满件】不可为空",g.value=!1;return}if(!i[e].rate){c.value="【折扣】不可为空",g.value=!1;return}if(e<i.length-1){const s=i[e],n=i[e+1];if(s.rateNum&&s.rateNum>=n.rateNum){c.value="下一个层级的【满件】需要大于上一个层级的【满件】",g.value=!1;return}if(s.rate&&s.rate<=n.rate){c.value="下一个层级的【优惠力度】要大于上一个层级的【优惠力度】",g.value=!1;return}}}c.value="",g.value=!0}},{deep:!0,immediate:!0}),(i,e)=>{const s=b("a-typography-text"),n=b("a-space"),f=b("a-radio"),O=b("a-radio-group"),k=b("a-input"),T=b("a-form-item"),X=b("a-range-picker"),S=b("a-button"),E=b("a-input-group"),Q=b("a-table"),Z=b("a-form"),h=b("a-card");return p(),D("div",null,[d(h,{bordered:!1},{default:a(()=>[d(Z,{ref_key:"modifyPriceForm",ref:M,model:t(l),style:{width:"100%"},layout:"horizontal","auto-label-width":""},{default:a(()=>[r("div",ye,[e[51]||(e[51]=r("h4",null,"活动信息",-1)),r("div",ve,[r("div",ce,[d(O,{modelValue:t(l).activeType,"onUpdate:modelValue":e[0]||(e[0]=o=>t(l).activeType=o),onChange:K},{default:a(()=>[d(f,{value:"CROSS",disabled:t(u)},{radio:a(({checked:o})=>[d(n,{align:"start",class:_(["custom-radio-card",{"custom-radio-card-checked":o}])},{default:a(()=>[e[14]||(e[14]=r("div",{className:"custom-radio-card-mask"},[r("div",{className:"custom-radio-card-mask-dot"})],-1)),r("div",null,[e[13]||(e[13]=r("div",{className:"custom-radio-card-title"}," 跨品多件优惠（满N件优惠） ",-1)),d(s,{type:"secondary"},{default:a(()=>e[12]||(e[12]=[m(" 同一商品或跨商品购买件数满足门槛，可享受总价立减或折扣，可用于提升客单价 ")])),_:1})])]),_:2},1032,["class"])]),_:1},8,["disabled"]),d(f,{value:"SAME",disabled:t(u)},{radio:a(({checked:o})=>[d(n,{align:"start",class:_(["custom-radio-card",{"custom-radio-card-checked":o}])},{default:a(()=>[e[17]||(e[17]=r("div",{className:"custom-radio-card-mask"},[r("div",{className:"custom-radio-card-mask-dot"})],-1)),r("div",null,[e[16]||(e[16]=r("div",{className:"custom-radio-card-title"}," 同品多件优惠（多件优惠） ",-1)),d(s,{type:"secondary"},{default:a(()=>e[15]||(e[15]=[m(" 同一商品可设置 “第二件半价”、“第二件0元” 等活动 ")])),_:1})])]),_:2},1032,["class"])]),_:1},8,["disabled"])]),_:1},8,["modelValue"])]),d(T,{field:"promotionName",label:"活动名称",rules:[t(R)]},{default:a(()=>[d(k,{modelValue:t(l).promotionName,"onUpdate:modelValue":e[1]||(e[1]=o=>t(l).promotionName=o),"allow-clear":"",style:{width:"400px"},disabled:t(u)},null,8,["modelValue","disabled"])]),_:1},8,["rules"]),d(T,{field:"rangeTime",label:"活动时间",rules:[t(R)]},{default:a(()=>[d(X,{modelValue:t(l).rangeTime,"onUpdate:modelValue":e[2]||(e[2]=o=>t(l).rangeTime=o),style:{width:"400px","margin-bottom":"20px"},disabled:t(u),"show-time":"",format:"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue","disabled"])]),_:1},8,["rules"]),d(T,{field:"discountType",label:"优惠类型",rules:[t(R)]},{default:a(()=>[d(O,{modelValue:t(l).discountType,"onUpdate:modelValue":e[3]||(e[3]=o=>t(l).discountType=o)},{default:a(()=>[t(l).activeType==="CROSS"?(p(),v(f,{key:0,value:"RATE",disabled:t(u)},{default:a(()=>e[18]||(e[18]=[m(" 满N件 打X折 ")])),_:1},8,["disabled"])):y("",!0),t(l).activeType==="CROSS"?(p(),v(f,{key:1,value:"PRICE",disabled:t(u)},{default:a(()=>e[19]||(e[19]=[m(" 满N件 打X元 ")])),_:1},8,["disabled"])):y("",!0),t(l).activeType==="SAME"?(p(),v(f,{key:2,value:"HALF",disabled:t(u)},{default:a(()=>e[20]||(e[20]=[m(" 第二件半价 ")])),_:1},8,["disabled"])):y("",!0),t(l).activeType==="SAME"?(p(),v(f,{key:3,value:"GIFT",disabled:t(u)},{default:a(()=>e[21]||(e[21]=[m(" 第二件0元 ")])),_:1},8,["disabled"])):y("",!0),t(l).activeType==="SAME"?(p(),v(f,{key:4,value:"DIY",disabled:t(u)},{default:a(()=>e[22]||(e[22]=[m(" 自定义优惠 ")])),_:1},8,["disabled"])):y("",!0)]),_:1},8,["modelValue"])]),_:1},8,["rules"]),(p(!0),D(re,null,ne(t(l).rulesItems,(o,w)=>(p(),D("div",{key:w},[t(l).activeType==="CROSS"?(p(),v(T,{key:0,field:"discountType",label:"",rules:[t(R)]},{default:a(()=>[t(l).discountType==="PRICE"?(p(),v(E,{key:0},{default:a(()=>[e[25]||(e[25]=r("span",{"mr-2":""},"满",-1)),d(k,{modelValue:o.priceNum,"onUpdate:modelValue":N=>o.priceNum=N,disabled:t(u),style:{width:"160px"},placeholder:"请输入件数"},{append:a(()=>e[23]||(e[23]=[m(" 件 ")])),_:2},1032,["modelValue","onUpdate:modelValue","disabled"]),e[26]||(e[26]=r("span",{"ml-2":"","mr-2":""},"减",-1)),d(k,{modelValue:o.price,"onUpdate:modelValue":N=>o.price=N,disabled:t(u),style:{width:"160px"},placeholder:"请输入金额"},null,8,["modelValue","onUpdate:modelValue","disabled"]),e[27]||(e[27]=r("span",{"ml-2":""},"元",-1)),d(S,{"ml-8":"",type:"primary",disabled:t(u)||t(l).rulesItems.length<=1,onClick:N=>P(w)},{default:a(()=>e[24]||(e[24]=[m(" 删除 ")])),_:2},1032,["disabled","onClick"])]),_:2},1024)):y("",!0),t(l).discountType==="RATE"?(p(),v(E,{key:1},{default:a(()=>[e[30]||(e[30]=r("span",{"mr-2":""},"满",-1)),d(k,{modelValue:o.rateNum,"onUpdate:modelValue":N=>o.rateNum=N,disabled:t(u),style:{width:"160px"},placeholder:"请输入件数"},{append:a(()=>e[28]||(e[28]=[m(" 件 ")])),_:2},1032,["modelValue","onUpdate:modelValue","disabled"]),e[31]||(e[31]=r("span",{"ml-2":"","mr-2":""},"打",-1)),d(k,{modelValue:o.rate,"onUpdate:modelValue":N=>o.rate=N,disabled:t(u),style:{width:"160px"},placeholder:"请输入折扣"},null,8,["modelValue","onUpdate:modelValue","disabled"]),e[32]||(e[32]=r("span",{"ml-2":""},"折",-1)),t(u)?y("",!0):(p(),v(S,{key:0,"ml-8":"",type:"primary",disabled:t(u)||t(l).rulesItems.length<=1,onClick:N=>P(w)},{default:a(()=>e[29]||(e[29]=[m(" 删除 ")])),_:2},1032,["disabled","onClick"]))]),_:2},1024)):y("",!0)]),_:2},1032,["rules"])):y("",!0)]))),128)),t(c)?(p(),v(T,{key:0,label:""},{default:a(()=>[r("span",Te,pe(t(c)),1)]),_:1})):y("",!0),!t(u)&&t(l).activeType==="CROSS"?(p(),v(T,{key:1,label:""},{default:a(()=>[d(S,{type:"primary",disabled:t(u)||t(l).rulesItems.length>=3,onClick:J},{default:a(()=>e[33]||(e[33]=[m(" 添加 ")])),_:1},8,["disabled"])]),_:1})):y("",!0),t(l).discountType==="DIY"&&t(l).activeType==="SAME"?(p(),v(T,{key:2,field:"discountWay",label:"优惠方式 ",rules:[t(R)]},{default:a(()=>[d(O,{modelValue:t(l).discountWay,"onUpdate:modelValue":e[4]||(e[4]=o=>t(l).discountWay=o)},{default:a(()=>[d(f,{value:"PRICE",disabled:t(u)},{default:a(()=>e[34]||(e[34]=[m(" 减现金 ")])),_:1},8,["disabled"]),d(f,{value:"RATE",disabled:t(u)},{default:a(()=>e[35]||(e[35]=[m(" 打折 ")])),_:1},8,["disabled"])]),_:1},8,["modelValue"])]),_:1},8,["rules"])):y("",!0)]),r("div",be,[t(l).discountWay==="PRICE"&&t(l).discountType==="DIY"?(p(),v(T,{key:0,field:"fullThreshold",label:"优惠金额",rules:[t(R)]},{default:a(()=>[t(l).discountWay==="PRICE"?(p(),v(E,{key:0},{default:a(()=>[e[37]||(e[37]=r("span",{"mr-2":""},"第",-1)),d(k,{modelValue:t(l).fullThreshold,"onUpdate:modelValue":e[5]||(e[5]=o=>t(l).fullThreshold=o),disabled:t(u),style:{width:"160px"},placeholder:"请输入数量"},{append:a(()=>e[36]||(e[36]=[m(" 件 ")])),_:1},8,["modelValue","disabled"]),e[38]||(e[38]=r("span",{"ml-2":"","mr-2":""},"减",-1)),d(k,{modelValue:t(l).fullMinus,"onUpdate:modelValue":e[6]||(e[6]=o=>t(l).fullMinus=o),disabled:t(u),style:{width:"160px"},placeholder:"请输入金额"},null,8,["modelValue","disabled"]),e[39]||(e[39]=r("span",{"ml-2":""},"元",-1))]),_:1})):y("",!0)]),_:1},8,["rules"])):y("",!0),t(l).discountWay==="RATE"&&t(l).discountType==="DIY"?(p(),v(T,{key:1,field:"fullThreshold",label:"优惠折扣",rules:[t(R),i.VARCHARDECIMAL10]},{default:a(()=>[t(l).discountWay==="RATE"?(p(),v(E,{key:0},{default:a(()=>[e[41]||(e[41]=r("span",{"mr-2":""},"第",-1)),d(k,{modelValue:t(l).fullThreshold,"onUpdate:modelValue":e[7]||(e[7]=o=>t(l).fullThreshold=o),disabled:t(u),style:{width:"160px"},placeholder:"请输入数量"},{append:a(()=>e[40]||(e[40]=[m(" 件 ")])),_:1},8,["modelValue","disabled"]),e[42]||(e[42]=r("span",{"ml-2":"","mr-2":""},"打",-1)),d(k,{modelValue:t(l).fullRate,"onUpdate:modelValue":e[8]||(e[8]=o=>t(l).fullRate=o),disabled:t(u),style:{width:"160px"},placeholder:"请输入折扣"},null,8,["modelValue","disabled"]),e[43]||(e[43]=r("span",{"ml-2":""},"折",-1))]),_:1})):y("",!0),e[44]||(e[44]=r("span",{class:"describe"},"优惠折扣为0-10之间数字，可有一位小数",-1))]),_:1},8,["rules"])):y("",!0),d(T,{field:"scopeType",label:"使用范围",rules:[t(R)]},{default:a(()=>[d(O,{modelValue:t(l).scopeType,"onUpdate:modelValue":e[9]||(e[9]=o=>t(l).scopeType=o)},{default:a(()=>[t(l).activeType==="CROSS"?(p(),v(f,{key:0,value:"ALL",disabled:t(u)},{default:a(()=>e[45]||(e[45]=[m(" 全店参与 ")])),_:1},8,["disabled"])):y("",!0),d(f,{value:"PORTION_GOODS",disabled:t(u)},{default:a(()=>e[46]||(e[46]=[m(" 部分商品参与 ")])),_:1},8,["disabled"])]),_:1},8,["modelValue"])]),_:1},8,["rules"]),t(l).scopeType==="PORTION_GOODS"&&t(l).promotionStatus==="NEW"?(p(),v(T,{key:2,style:{width:"100%"}},{default:a(()=>[t(l).promotionStatus==="NEW"?(p(),D("div",ge,[r("div",ke,[d(S,{disabled:t(u),type:"outline",onClick:$},{default:a(()=>e[47]||(e[47]=[m(" 选择商品 ")])),_:1},8,["disabled"])])])):y("",!0)]),_:1})):y("",!0),t(l).scopeType==="PORTION_GOODS"?(p(),v(T,{key:3},{default:a(()=>[d(Q,{"selected-keys":t(A),"onUpdate:selectedKeys":e[10]||(e[10]=o=>me(A)?A.value=o:null),columns:F,data:t(V),"row-selection":t(W),"row-key":"skuId",pagination:!1,style:{width:"100%"}},{Optiona:a(({rowIndex:o})=>[d(S,{type:"text",status:"danger",disabled:t(u),onClick:w=>z(o)},{default:a(()=>e[48]||(e[48]=[m(" 删除 ")])),_:2},1032,["disabled","onClick"])]),_:1},8,["selected-keys","data","row-selection"])]),_:1})):y("",!0),r("div",null,[d(S,{style:{"margin-right":"5px"},onClick:e[11]||(e[11]=o=>t(G).push({name:"full-discount"}))},{default:a(()=>e[49]||(e[49]=[m(" 返回 ")])),_:1}),t(u)?y("",!0):(p(),v(S,{key:0,type:"primary",disabled:t(u),onClick:B},{default:a(()=>e[50]||(e[50]=[m(" 提交 ")])),_:1},8,["disabled"]))])])])]),_:1},8,["model"])]),_:1}),d(t(le),{ref_key:"skuSelect",ref:Y,"goods-or-sku":!0,"default-goods-selected-list":t(V),api:t(ee),onChange:j},null,8,["default-goods-selected-list","api"])])}}}),Ee=fe(Ne,[["__scopeId","data-v-f337c82a"]]);export{Ee as default};
