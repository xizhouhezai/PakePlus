import{x as X,Q as W,R as ee,S as oe,T as le}from"./goods-CB7YWqUH.js";import{e as P,a as G}from"./filters-D05Q2eUM.js";import{R as v}from"./validator-B8pIxTAL.js";import{V as te,I as ae}from"./dist-PezRi_EG.js";import{d as se,n as de,p as ie,r as I,af as w,h as ue,E as ne,b as f,o as m,c as M,e as s,w as d,u as o,k as p,j as y,s as T,q as re,f as b,F as pe,i as me,M as k,t as fe,_ as ye}from"./index-C4AMdMz2.js";const Te={class:"base-info-item"},ce={class:"form-item-view"},be={class:"form-item-view"},ge={style:{display:"flex","margin-bottom":"10px"}},ve=se({__name:"coupon-publish",setup(Ie){const U=de(),O=ie(),g=I(0),N=I([]),C=I(),E=I([]),L=I([w().format("YYYY-MM-DD HH:mm:ss"),w().add(1,"month").format("YYYY-MM-DD HH:mm:ss")]),Y=[{title:"商品名称",dataIndex:"goodsName"},{title:"商品价格",dataIndex:"price"},{title:"库存",dataIndex:"quantity"}],q={title:"操作",width:250,fixed:"right",methods:[{title:"操作",slot:!0,slotTemplate:"operation"}]},x=I(null),u=I(O.query.onlyView),l=I({storeCommission:0,publishNum:0,scopeType:"ALL",couponLimitNum:1,couponType:"PRICE",couponName:"",promotionName:"",getType:"FREE",promotionGoodsList:[],scopeIdGoods:[],rangeDayType:"",couponDiscount:"",price:0,description:"",consumeThreshold:0,rangeTime:[],effectiveDays:1}),F=[{value:"ZERO",label:"立减"},{value:"PRICE",label:"满减"},{value:"DISCOUNT",label:"打折"}];function A(){x.value.modalData.visible=!0}function H(n){l.value.promotionGoodsList=[],n.forEach(e=>{l.value.promotionGoodsList.push({goodsName:e.goodsName,price:e.price,originalPrice:e.price,quantity:e.quantity,storeId:e.storeId,sellerName:e.sellerName,skuId:e.id})}),l.value.promotionGoodsList=l.value.promotionGoodsList.map((e,t)=>({...e,key:t+1}))}function S(n,e){return n.forEach(t=>{Array.isArray(t)&&S(t,e),Array.isArray(t)||e.includes(t)||e.push(t)}),e}function R(){U.push({name:"coupon"})}function B(n){l.value.promotionGoodsList.splice(n,1)}function j(){R()}async function J(){var e;if(!await((e=C.value)==null?void 0:e.validate())){const t=JSON.parse(JSON.stringify(l.value));if(l.value.rangeTime){const{startTime:r,endTime:c}=P(l.value.rangeTime);t.startTime=r,t.endTime=c}if(g.value===1){t.rangeDayType="FIXEDTIME";const{startTime:r,endTime:c}=P(l.value.useRangeTime);t.useStartTime=r,t.useEndTime=c}else t.rangeDayType="DYNAMICTIME",delete t.useRangeTime,delete t.rangeTime;let i=[];if(t.scopeType==="PORTION_GOODS"&&(!t.promotionGoodsList||t.promotionGoodsList.length===0)){k.warning("请选择指定商品");return}if(t.scopeType==="PORTION_GOODS_CATEGORY"&&(!t.scopeIdGoods||t.scopeIdGoods.length===0)){k.warning("请选择商品分类");return}t.scopeType!=="PORTION_GOODS_CATEGORY"&&delete t.scopeIdGoods,t.scopeType==="PORTION_GOODS"?(t.promotionGoodsList=t.promotionGoodsList.map(r=>(i.push(r.skuId),{goodsName:r.goodsName,originalPrice:r.originalPrice,price:r.price,quantity:r.quantity,skuId:r.skuId,storeId:r.storeId})),t.scopeId=i.toString()):t.scopeType==="ALL"?delete t.promotionGoodsList:t.scopeType==="PORTION_GOODS_CATEGORY"&&(i=S(t.scopeIdGoods,[]),t.scopeId=i.toString(),delete t.promotionGoodsList),delete t.scopeIdGoods,O.query.id?(delete t.consumeLimit,delete t.updateTime,ee(t).then(r=>{r.data.success&&(k.success("优惠券修改成功"),R())})):(delete t.id,W(t).then(r=>{r.data.success&&(k.success("优惠券发送成功"),R())}))}}async function Q(){const n=await oe();n.data.success&&(N.value=n.data.result,N.value=N.value.map(e=>(e.children&&e.children.length?e.children=e.children.map(t=>(t.children?t.children=t.children.map(i=>({value:i.id,label:i.name})):t.children=null,{value:t.id,label:t.name,children:t.children||null})):e.children=null,{value:e.id,label:e.name,children:e.children})))}async function Z(){const n=await le(O.query.id);if(n.data.success){const e=n.data.result;l.value=n.data.result,l.value.scopeId&&(l.value.scopeIdGoods=l.value.scopeId.split(",")),e.startTime&&e.endTime&&(l.value.rangeTime=[G(Number(new Date(e.startTime))/1e3,"yyyy-MM-dd"),G(Number(new Date(e.endTime))/1e3,"yyyy-MM-dd")]),e.useEndTime&&e.useStartTime&&(l.value.useRangeTime=[G(Number(new Date(e.useStartTime))/1e3,"yyyy-MM-dd"),G(Number(new Date(e.useEndTime))/1e3,"yyyy-MM-dd")]),e.promotionGoodsList||(e.promotionGoodsList=[]),g.value=e.rangeDayType==="DYNAMICTIME"?0:1}}return ue(async()=>{l.value.getType=O.query.type;const n=w().format("YYYYMMDD HH:mm:ss");l.value.couponName=`优惠券-${n}`,l.value.useRangeTime=L.value,l.value.rangeTime=L.value,Q(),O.query.id&&Z()}),ne(()=>l.value.getType,n=>{g.value===0&&delete l.value.useRangeTime,n!=="FREE"&&delete l.value.rangeTime},{deep:!0,immediate:!0}),(n,e)=>{const t=f("a-input"),i=f("a-form-item"),r=f("a-range-picker"),c=f("a-radio"),_=f("a-radio-group"),V=f("a-input-number"),$=f("a-input-group"),D=f("a-button"),h=f("a-cascader"),z=f("a-form"),K=f("a-card");return m(),M("div",null,[s(K,null,{default:d(()=>[s(z,{ref_key:"modifyPriceForm",ref:C,model:o(l),style:{width:"100%"},layout:"horizontal","auto-label-width":""},{default:d(()=>[p("div",Te,[e[32]||(e[32]=p("h4",null,"基本规则",-1)),p("div",ce,[s(i,{field:"couponName",label:"优惠券名称",rules:[o(v)]},{default:d(()=>[s(t,{modelValue:o(l).couponName,"onUpdate:modelValue":e[0]||(e[0]=a=>o(l).couponName=a),disabled:o(u),"allow-clear":"",style:{width:"260px"}},null,8,["modelValue","disabled"])]),_:1},8,["rules"]),o(l).getType==="FREE"?(m(),y(i,{key:0,field:"rangeTime",label:"领取时间",rules:[o(v)]},{default:d(()=>[s(r,{modelValue:o(l).rangeTime,"onUpdate:modelValue":e[1]||(e[1]=a=>o(l).rangeTime=a),style:{width:"254px"},disabled:o(u)},null,8,["modelValue","disabled"])]),_:1},8,["rules"])):T("",!0),s(i,{field:"rangeTime",label:"使用时间"},{default:d(()=>[s(_,{modelValue:o(g),"onUpdate:modelValue":e[2]||(e[2]=a=>re(g)?g.value=a:null)},{default:d(()=>[s(c,{disabled:o(u),value:0},{default:d(()=>e[16]||(e[16]=[b(" 限制有效天数 ")])),_:1},8,["disabled"]),s(c,{disabled:o(u)||o(l).getType!=="FREE",value:1},{default:d(()=>e[17]||(e[17]=[b(" 限制日期范围 ")])),_:1},8,["disabled"])]),_:1},8,["modelValue"])]),_:1}),o(g)===1?(m(),y(i,{key:1,field:"rangeTime",label:"",rules:[o(v)]},{default:d(()=>[s(r,{modelValue:o(l).useRangeTime,"onUpdate:modelValue":e[3]||(e[3]=a=>o(l).useRangeTime=a),style:{width:"254px"},disabled:o(u)},null,8,["modelValue","disabled"])]),_:1},8,["rules"])):T("",!0),o(g)===0?(m(),y(i,{key:2,field:"effectiveDays",label:"",rules:[o(v)]},{default:d(()=>[s(V,{modelValue:o(l).effectiveDays,"onUpdate:modelValue":e[4]||(e[4]=a=>o(l).effectiveDays=a),style:{width:"260px"},class:"input-demo",min:1,max:365,disabled:o(u)},{append:d(()=>e[18]||(e[18]=[b(" 天内可用 ")])),_:1},8,["modelValue","disabled"])]),_:1},8,["rules"])):T("",!0),s(i,{field:"storeCommission",label:"店铺承担比例"},{default:d(()=>[s(V,{modelValue:o(l).storeCommission,"onUpdate:modelValue":e[5]||(e[5]=a=>o(l).storeCommission=a),min:0,disabled:o(u),"allow-clear":"",style:{width:"260px"}},{append:d(()=>e[19]||(e[19]=[p("span",null,"%",-1)])),_:1},8,["modelValue","disabled"]),e[20]||(e[20]=p("span",{class:"describe"},"店铺承担比例,输入0-100之间数值",-1))]),_:1}),e[27]||(e[27]=p("h4",null,"优惠设置",-1)),s(i,{field:"couponType",label:"优惠方式"},{default:d(()=>[s(_,{modelValue:o(l).couponType,"onUpdate:modelValue":e[6]||(e[6]=a=>o(l).couponType=a),disabled:o(u)},{default:d(()=>[(m(),M(pe,null,me(F,a=>s(c,{key:a.value,value:a.value},{default:d(()=>[b(fe(a.label),1)]),_:2},1032,["value"])),64))]),_:1},8,["modelValue","disabled"])]),_:1}),o(l).couponType==="DISCOUNT"?(m(),y(i,{key:3,field:"couponDiscount",label:"折扣"},{default:d(()=>[s(t,{modelValue:o(l).couponDiscount,"onUpdate:modelValue":e[7]||(e[7]=a=>o(l).couponDiscount=a),disabled:o(u),"allow-clear":"",style:{width:"260px"}},null,8,["modelValue","disabled"]),e[21]||(e[21]=p("span",{class:"describe"},"请输入0-10之间数字,可以输入一位小数",-1))]),_:1})):T("",!0),o(l).couponType==="ZERO"?(m(),y(i,{key:4,field:"price",label:"立减金额",rules:[o(v)]},{default:d(()=>[s(V,{modelValue:o(l).price,"onUpdate:modelValue":e[8]||(e[8]=a=>o(l).price=a),min:0,disabled:o(u),"allow-clear":"",style:{width:"260px"}},null,8,["modelValue","disabled"])]),_:1},8,["rules"])):T("",!0),o(l).couponType==="PRICE"?(m(),y(i,{key:5,field:"price",label:"满减面额",rules:[o(v)]},{default:d(()=>[s($,null,{default:d(()=>[e[22]||(e[22]=p("span",{"mr-2":""},"满",-1)),s(V,{modelValue:o(l).consumeThreshold,"onUpdate:modelValue":e[9]||(e[9]=a=>o(l).consumeThreshold=a),min:0,disabled:o(u),style:{width:"160px"},placeholder:"请输入金额"},null,8,["modelValue","disabled"]),e[23]||(e[23]=p("span",{"ml-2":"","mr-2":""},"减",-1)),s(V,{modelValue:o(l).price,"onUpdate:modelValue":e[10]||(e[10]=a=>o(l).price=a),min:0,disabled:o(u),style:{width:"160px"},placeholder:"请输入金额"},null,8,["modelValue","disabled"]),e[24]||(e[24]=p("span",{"ml-2":""},"元",-1))]),_:1})]),_:1},8,["rules"])):T("",!0),o(l).getType==="FREE"?(m(),y(i,{key:6,field:"publishNum",label:"发放数量",rules:[o(v)]},{default:d(()=>[s(V,{modelValue:o(l).publishNum,"onUpdate:modelValue":e[11]||(e[11]=a=>o(l).publishNum=a),min:0,disabled:o(u),"allow-clear":"",style:{width:"260px"}},null,8,["modelValue","disabled"]),e[25]||(e[25]=p("div",{class:"tips"}," 如果发放数量为0时,则代表不限制发放数量 ",-1))]),_:1},8,["rules"])):T("",!0),o(l).getType==="FREE"?(m(),y(i,{key:7,field:"couponLimitNum",label:"每人限领",rules:[o(v)]},{default:d(()=>[s(V,{modelValue:o(l).couponLimitNum,"onUpdate:modelValue":e[12]||(e[12]=a=>o(l).couponLimitNum=a),min:0,disabled:o(u),"allow-clear":"",style:{width:"260px"}},null,8,["modelValue","disabled"]),e[26]||(e[26]=p("div",{class:"tips"}," 如果领取数量为0时,则代表不限制领取数量 ",-1))]),_:1},8,["rules"])):T("",!0)]),p("div",be,[s(i,{field:"scopeType",label:"使用范围"},{default:d(()=>[s(_,{modelValue:o(l).scopeType,"onUpdate:modelValue":e[13]||(e[13]=a=>o(l).scopeType=a),type:"button",disabled:o(u)},{default:d(()=>[s(c,{value:"ALL"},{default:d(()=>e[28]||(e[28]=[b(" 全品类 ")])),_:1}),s(c,{value:"PORTION_GOODS"},{default:d(()=>e[29]||(e[29]=[b(" 指定商品 ")])),_:1})]),_:1},8,["modelValue","disabled"])]),_:1}),o(l).scopeType==="PORTION_GOODS"?(m(),y(i,{key:0},{default:d(()=>[p("div",ge,[s(D,{disabled:o(u),type:"outline",onClick:A},{default:d(()=>e[30]||(e[30]=[b(" 选择商品 ")])),_:1},8,["disabled"])])]),_:1})):T("",!0),o(l).scopeType==="PORTION_GOODS"?(m(),y(i,{key:1},{default:d(()=>[s(o(te),{columns:Y,methods:q,"data-list":o(l).promotionGoodsList,bordered:!0,"default-selected-keys":o(E),"enable-pagination":!1,onSelectionChanges:e[14]||(e[14]=a=>{E.value=a})},{operation:d(({rowIndex:a})=>[s(D,{type:"text",status:"danger",disabled:o(u),onClick:Ve=>B(a)},{default:d(()=>e[31]||(e[31]=[b(" 删除 ")])),_:2},1032,["disabled","onClick"])]),_:1},8,["data-list","default-selected-keys"])]),_:1})):T("",!0),o(l).scopeType==="PORTION_GOODS_CATEGORY"?(m(),y(i,{key:2},{default:d(()=>[s(h,{"model-value":o(l).scopeIdGoods,"onUpdate:modelValue":e[15]||(e[15]=a=>o(l).scopeIdGoods=a),options:o(N),style:{width:"260px"},disabled:o(u),"allow-clear":"","path-mode":!0},null,8,["model-value","options","disabled"])]),_:1})):T("",!0)])])]),_:1},8,["model"]),s(D,{style:{"margin-right":"5px"},onClick:j},{default:d(()=>e[33]||(e[33]=[b(" 返回 ")])),_:1}),s(D,{disabled:o(u),type:"primary",onClick:J},{default:d(()=>e[34]||(e[34]=[b(" 提交 ")])),_:1},8,["disabled"])]),_:1}),s(o(ae),{ref_key:"skuSelect",ref:x,api:o(X),"goods-or-sku":!0,"is-single":!1,"default-goods-selected-list":o(l).promotionGoodsList,onChange:H},null,8,["api","default-goods-selected-list"])])}}}),Re=ye(ve,[["__scopeId","data-v-0460102b"]]);export{Re as default};
