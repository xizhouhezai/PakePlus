import{x as K}from"./goods-CB7YWqUH.js";import{T as Q,U as W,V as X}from"./promotion-ChRoyrm_.js";import{R as V}from"./validator-B8pIxTAL.js";import{I as Z}from"./dist-PezRi_EG.js";import{d as ee,r as f,p as te,n as oe,af as I,a as ae,h as se,b as m,o as D,c as ie,e as s,w as i,u as t,k as y,A as ne,f as T,j as G,q as le,s as M,M as w,_ as de}from"./index-C4AMdMz2.js";const ue={class:"base-info-item"},me={class:"form-item-view"},re={class:"form-item-view"},pe={style:{display:"flex"}},ce={style:{display:"flex","margin-bottom":"10px"}},fe=ee({__name:"minus-detail",setup(ye){const C=f(),_=te(),R=oe(),u=f(_.query.onlyView),r=f(_.query.status),h=f(null),p=f([]),N=f([]),d=f({promotionName:"",rangeTime:[I().format("YYYY-MM-DD HH:mm:ss"),I().add(7,"day").format("YYYY-MM-DD HH:mm:ss")],scopeType:"PORTION_GOODS",quantityConstraint:!1,promotionGoodsList:[]}),L=[{title:"商品名称",dataIndex:"goodsName"},{title:"一口价",dataIndex:"price",slotName:"price"},{title:"活动库存",dataIndex:"quantity",slotName:"quantity"},{title:"每人限购",dataIndex:"limitNum",slotName:"limitNum"},{title:"操作",slotName:"Optiona"}],O=ae({type:"checkbox",showCheckedAll:!0,onlyCurrent:!0}),k=f([]);async function Y(){const n=await Q(_.query.id);if(n.data.success){const e=n.data.result;e.scopeType==="ALL"&&(e.promotionGoodsList=[]),e.fullMinusFlag?(e.discountType="fullMinusFlag",delete e.fullMinusFlag):(e.discountType="fullRateFlag",delete e.fullRateFlag),e.rangeTime=[],e.rangeTime.push(e.startTime,e.endTime),d.value=e,p.value=e.promotionGoodsList}}function q(){R.push({name:"minus"})}function A(n,e){N.value=e}function U(n){n||(N.value=[])}function F(n){if(!n)return!1;const e=N.value;if(e&&e.length){const o=e[0]&&Math.abs((new Date(n).getTime()-e[0].getTime())/864e5)>7;return e[1]&&Math.abs((new Date(n).getTime()-e[1].getTime())/(24*60*60*1e3))>6||o}return!1}async function P(){var e;if(!await((e=C.value)==null?void 0:e.validate())){const o=JSON.parse(JSON.stringify(d.value));if(o.promotionGoodsList=p.value,o.startTime=d.value.rangeTime[0],o.endTime=d.value.rangeTime[1],o.scopeType==="PORTION_GOODS"&&(!o.promotionGoodsList||o.promotionGoodsList.length===0)){w.warning("请选择指定商品");return}if(o.scopeType==="ALL")delete o.promotionGoodsList,o.number=-1;else{const l=[];o.number=1,o.promotionGoodsList.forEach(b=>{b.startTime=o.startTime,b.endTime=o.endTime,l.push(b.skuId)}),o.scopeId=l.toString()}o.discountType==="fullMinusFlag"?o.fullMinusFlag=!0:o.fullRateFlag=!0,delete o.rangeTime,_.query.id?(delete o.updateTime,X(o).then(l=>{l.data.success&&(w.success("编辑活动成功"),q())})):(delete o.id,W(o).then(l=>{l&&l.data&&l.data.success&&(w.success("添加活动成功"),q())}))}}function H(){h.value.modalData.visible=!0}function E(n){const e=[];n.forEach(o=>{const l={settlementPrice:o.settlementPrice||0,pointsGoodsCategoryId:o.pointsGoodsCategoryId||0,pointsGoodsCategoryName:o.pointsGoodsCategoryName||"",activeStock:o.activeStock||0,points:o.points||0,skuId:o.id,goodsId:o.goodsId,originalPrice:o.price||0,thumbnail:o.thumbnail||"",goodsName:o.goodsName||"",quantity:o.quantity||"",storeName:o.storeName||"",price:o.price||"",limitNum:o.limitNum||1};e.push(l)}),p.value=e}function $(n){p.value.splice(n,1)}return se(async()=>{_.query.id&&Y();const n=I().format("YYYYMMDD HH:mm:ss");d.value.promotionName=`单品直降-${n}`}),(n,e)=>{const o=m("a-input"),l=m("a-form-item"),b=m("a-range-picker"),x=m("a-radio"),B=m("a-radio-group"),v=m("a-button"),S=m("a-input-number"),j=m("a-table"),z=m("a-form"),J=m("a-card");return D(),ie("div",null,[s(J,{bordered:!1},{default:i(()=>[s(z,{ref_key:"modifyPriceForm",ref:C,model:t(d),style:{width:"100%"},layout:"horizontal","auto-label-width":""},{default:i(()=>[y("div",ue,[e[11]||(e[11]=y("h4",null,"活动信息",-1)),y("div",me,[s(l,{field:"promotionName",label:"活动名称",rules:[t(V)]},{default:i(()=>[s(o,{modelValue:t(d).promotionName,"onUpdate:modelValue":e[0]||(e[0]=a=>t(d).promotionName=a),"allow-clear":"",style:{width:"400px"},disabled:t(u)||t(r)==="START"},null,8,["modelValue","disabled"])]),_:1},8,["rules"]),s(l,{field:"rangeTime",label:"活动时间",rules:[t(V)]},{default:i(()=>[s(b,{modelValue:t(d).rangeTime,"onUpdate:modelValue":e[1]||(e[1]=a=>t(d).rangeTime=a),style:ne([{width:"254px","margin-bottom":"20px"},{width:"400px"}]),disabled:t(u)||t(r)==="START","disabled-date":F,"show-time":"",format:"YYYY-MM-DD HH:mm:ss",onSelect:A,onPopupVisibleChange:U},null,8,["modelValue","disabled"])]),_:1},8,["rules"])]),y("div",re,[s(l,{field:"quantityConstraint",label:"是否设置活动库存",rules:[t(V)]},{default:i(()=>[s(B,{modelValue:t(d).quantityConstraint,"onUpdate:modelValue":e[2]||(e[2]=a=>t(d).quantityConstraint=a)},{default:i(()=>[s(x,{value:!1,disabled:t(u)||t(r)==="START"},{default:i(()=>e[5]||(e[5]=[T(" 不限活动库存 ")])),_:1},8,["disabled"]),s(x,{value:!0,disabled:t(u)||t(r)==="START"},{default:i(()=>e[6]||(e[6]=[T(" 限活动库存 ")])),_:1},8,["disabled"])]),_:1},8,["modelValue"])]),_:1},8,["rules"]),s(l,{style:{width:"100%"}},{default:i(()=>[y("div",pe,[y("div",ce,[s(v,{disabled:t(u)||t(r)==="START",type:"outline",onClick:H},{default:i(()=>e[7]||(e[7]=[T(" 选择商品 ")])),_:1},8,["disabled"])])])]),_:1}),t(d).scopeType==="PORTION_GOODS"?(D(),G(l,{key:0},{default:i(()=>[s(j,{"selected-keys":t(k),"onUpdate:selectedKeys":e[3]||(e[3]=a=>le(k)?k.value=a:null),columns:L,data:t(p),"row-selection":t(O),"row-key":"skuId",pagination:!1,style:{width:"100%"}},{quantity:i(({record:a,rowIndex:g})=>[s(S,{modelValue:a.quantity,"onUpdate:modelValue":c=>a.quantity=c,disabled:t(u)||!t(d).quantityConstraint||t(r)==="START",min:1,onInput:c=>t(p)[g].quantity=a.quantity},null,8,["modelValue","onUpdate:modelValue","disabled","onInput"])]),price:i(({record:a,rowIndex:g})=>[s(S,{modelValue:a.price,"onUpdate:modelValue":c=>a.price=c,disabled:t(u)||t(r)==="START",precision:2,min:.01,onInput:c=>t(p)[g].price=a.price},null,8,["modelValue","onUpdate:modelValue","disabled","onInput"])]),limitNum:i(({record:a,rowIndex:g})=>[s(S,{modelValue:a.limitNum,"onUpdate:modelValue":c=>a.limitNum=c,disabled:t(u)||t(r)==="START",min:1,onInput:c=>t(p)[g].limitNum=a.limitNum},null,8,["modelValue","onUpdate:modelValue","disabled","onInput"])]),Optiona:i(({rowIndex:a})=>[s(v,{type:"text",status:"danger",disabled:t(u)||t(r)==="START",onClick:g=>$(a)},{default:i(()=>e[8]||(e[8]=[T(" 删除 ")])),_:2},1032,["disabled","onClick"])]),_:1},8,["selected-keys","data","row-selection"])]),_:1})):M("",!0),y("div",null,[s(v,{style:{"margin-right":"5px"},onClick:e[4]||(e[4]=a=>t(R).push({name:"minus"}))},{default:i(()=>e[9]||(e[9]=[T(" 返回 ")])),_:1}),t(u)?M("",!0):(D(),G(v,{key:0,type:"primary",disabled:t(u),onClick:P},{default:i(()=>e[10]||(e[10]=[T(" 提交 ")])),_:1},8,["disabled"]))])])])]),_:1},8,["model"])]),_:1}),s(t(Z),{ref_key:"skuSelect",ref:h,api:t(K),"goods-or-sku":!0,"default-goods-selected-list":t(p),onChange:E},null,8,["api","default-goods-selected-list"])])}}}),Ne=de(fe,[["__scopeId","data-v-9514b910"]]);export{Ne as default};
